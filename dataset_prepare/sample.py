import re

# 牌譜データを文字列として読み込む（仮定）
log = '''<mjloggm ver="2.3">
<GO type="169"/>
<UN n0="%E4%B8%89%E6%B2%B3%E5%B1%8B" n1="%E4%B8%89%E7%94%B0%E6%9D%91%E8%8C%9C" n2="%E3%83%81%E3%83%A3%E3%82%AA%E3%83%AA" n3="%4C%49%54%48%49%55%4D" dan="16,16,16,16" rate="2096,2000,2030,2008" sx="M,F,M,F"/>
<TAIKYOKU oya="0"/>
<INIT seed="0,0,0,3,0,107" ten="250,250,250,250" oya="0" hai0="130,75,119,122,27,99,80,13,126,81,82,35,101" hai1="64,50,127,8,47,68,95,1,92,100,124,39,61" hai2="51,4,108,135,5,0,102,40,21,53,125,6,20" hai3="72,112,9,32,14,28,89,70,15,57,10,26,30" shuffle="mt19937ar,591BE7E0,80E452F4,E9231F68,A37C5039,8331744A,2704A370,C4D99CFE,1F611F51"/>
<T123/><D119/><U93/><E100/><V44/><F108/><W134/><G70/><T12/><D126/><N who="1" m="48171" /><E39/><V88/><F102/><W63/><G112/><T103/><D130/><U25/><E25/><V83/><F125/><W116/><G116/><T77/><D101/><U131/><E131/><V86/><F135/><W87/><G30/><T109/><D109/><U41/><E8/><V69/><F69/><W65/><G134/><T54/><D54/><U45/><E47/><V117/><F117/><W84/><G72/><T85/><D81/><U113/><E1/><V17/><F0/><W48/><G48/><T121/><D27/><U59/><E113/><V79/><F17/><W96/><G96/><T97/><D35/><U94/><N who="1" m="23552" /><DORA hai="46" /><U111/><E111/><V16/><F79/><W43/><G43/><T22/><D103/><U118/><E118/><V110/><F110/><W52/><G89/><T49/><D13/><U38/><E38/><V3/><F3/><W18/><REACH who="3" step="1"/><G65/><REACH who="3" step="2"/><T34/><D99/><U33/><E33/><V37/><REACH who="2" step="1"/><F16/>
<AGARI ba="0,1" hai="9,10,14,15,16,18,26,28,32,52,57,63,84,87" machi="16" ten="30,12000,2" yaku="1,1,2,1,7,1,9,1,54,2,53,0" doraHai="107,46" doraHaiUra="42,98" who="3" fromWho="2" sc="250,0,250,0,250,-120,240,130" />
<INIT seed="1,0,0,0,3,62" ten="250,250,130,370" oya="1" hai0="135,108,91,69,29,130,31,89,100,119,71,109,134" hai1="123,97,75,56,65,106,112,8,88,3,57,73,124" hai2="50,32,121,67,98,24,35,107,47,64,83,48,93" hai3="9,94,36,114,44,6,120,118,90,45,85,18,1" shuffle="mt19937ar,FB5D5B28,21C0306D,20A1B857,68ADF2CB,91F6F41B,E4863C64,259876A3,FF0655A5"/>
<U76/><E123/><V117/><F107/><W34/><G114/><T78/><D78/><U96/><E112/><V22/><F121/><W30/><G120/><T74/><D74/><U42/><E124/><V68/><F68/><N who="0" m="26186" /><D100/><U21/><E42/><V13/><F13/><W102/><G18/><T53/><D53/><U131/><E131/><V23/><F117/><W51/><G36/><T105/><D105/><U87/><E21/><V26/><F83/><W25/><G118/><T95/><D119/><U54/><E106/><V27/><F35/><W14/><G102/><T28/><D95/><U66/><E75/><V101/><F32/><W5/><G51/><N who="2" m="19497" /><F47/><W127/><G127/><T61/><D61/><U39/><E39/><V70/><F70/><W104/><G104/><T99/><D99/><N who="1" m="37963" /><E3/><V55/><F55/><W82/><G1/><T15/><D15/><U10/><E73/><V103/><F103/><W2/><G2/><T41/><D41/><U111/><E76/><V128/><F128/><W43/><G43/><T4/><D130/><U84/><E87/><V126/><F126/><W46/><REACH who="3" step="1"/><G5/><REACH who="3" step="2"/><T115/><D4/><U60/><E111/><N who="0" m="42569" /><D115/><U116/><E116/><V63/><F63/><W49/><G49/><T125/><D125/><U59/><E60/><V0/><F0/><W129/><G129/><T133/>
<AGARI ba="0,1" hai="28,29,31,89,91,133,134,135" m="42569,26186" machi="133" ten="50,8000,1" yaku="28,2,20,1,14,1" doraHai="62" who="0" fromWho="0" sc="250,90,250,-40,130,-20,360,-20" />
<INIT seed="2,0,0,3,2,13" ten="340,210,110,340" oya="2" hai0="74,20,64,99,17,81,78,110,32,61,1,113,5" hai1="104,16,40,50,107,108,9,37,26,128,111,47,65" hai2="134,29,38,45,11,62,127,92,48,4,68,112,22" hai3="71,35,44,42,126,98,30,3,52,114,115,76,90" shuffle="mt19937ar,B7198C8B,4C7B6162,BEDD439E,61F85FB9,3AD3D474,7FC52FB5,A002704B,1F63E021"/>
<V55/><F112/><W116/><G71/><T86/><D32/><U6/><E128/><V95/><F134/><W21/><G35/><T69/><D113/><N who="3" m="43017" /><G76/><T41/><D41/><U10/><E65/><V117/><F117/><W131/><G3/><T132/><D132/><U91/><E37/><V31/><F127/><W58/><G131/><T77/><D99/><U121/><E121/><V51/><F38/><W105/><G105/><T39/><D39/><U120/><E120/><V80/><F80/><W54/><G58/><T53/><D53/><U96/><E9/><V82/><F82/><W2/><G2/><T85/><D78/><U46/><E47/><V83/><F83/><W119/><G90/><T124/><D124/><U66/><E66/><V123/><F123/><W79/><G98/><T101/><D101/><U129/><E129/><V100/><F51/><N who="3" m="27031" /><G79/><T27/><REACH who="0" step="1"/><D110/><REACH who="0" step="2"/><U49/><E96/><V94/><F100/><W25/><G126/><T102/><D102/><U133/><E133/><V8/><F68/><W18/><G30/><T0/><D0/><U24/><E111/><V34/><F34/><W122/><G122/><T135/><D135/><U73/><E108/><V15/><F31/><W118/>
<AGARI ba="0,1" hai="18,21,25,52,54,116,118,119" m="27031,43017" machi="118" ten="40,5200,0" yaku="11,1,52,1,54,1" doraHai="13" who="3" fromWho="3" sc="330,-13,210,-13,110,-26,340,62" />
<INIT seed="3,0,0,5,1,14" ten="317,197,84,402" oya="3" hai0="26,0,129,110,62,60,8,115,121,112,37,27,113" hai1="128,67,96,88,45,100,76,44,125,28,83,94,47" hai2="2,114,29,105,116,33,80,40,81,99,50,10,95" hai3="126,78,102,104,84,101,38,18,6,59,54,122,32" shuffle="mt19937ar,61F72E8F,91B9FE72,61998D89,545D1381,BE594B1F,5CED8319,98088AFF,AB9187A3"/>
<W134/><G122/><T22/><D121/><U97/><E128/><V64/><F105/><W106/><G32/><T19/><D37/><U49/><E125/><V12/><F116/><W89/><G38/><T4/><D129/><U20/><E67/><V120/><F120/><W132/><G6/><T48/><D110/><U16/><E28/><V41/><F2/><W39/><G39/><T9/><D9/><U66/><E66/><V57/><F114/><W42/><G42/><T127/><D127/><U117/><E117/><V11/><F11/><W30/><G30/><T5/><D5/><U34/><E34/><V92/><F92/><W74/><G126/><T91/><D27/><U90/><E49/><V103/><F33/><W31/><G31/><T98/><REACH who="0" step="1"/><D48/><REACH who="0" step="2"/><U93/><E100/><V25/><F25/><W63/><G102/><T56/><D56/><U58/><E58/><V109/><F109/><W52/><G59/><T79/><D79/><U73/><E45/><V131/><F131/><W77/><G101/><T85/><D85/><U72/><E73/><V15/><F50/><W82/><G84/><T43/><D43/><U21/><E21/><V68/><F57/><W23/><G78/><T61/><D61/><U7/><E7/><V70/><F103/><W24/><G63/><T69/><D69/><U87/><E72/><V75/><F70/><W118/><G118/><T3/><D3/><U13/>
<AGARI ba="0,1" hai="13,16,20,44,47,76,83,87,88,90,93,94,96,97" machi="13" ten="20,12000,2" yaku="0,1,7,1,9,1,8,1,52,1,54,2" doraHai="14" who="1" fromWho="1" sc="307,-30,197,130,84,-30,402,-60" />
<INIT seed="4,0,0,4,3,19" ten="277,327,54,342" oya="0" hai0="68,99,83,44,5,118,53,16,78,40,75,87,27" hai1="123,135,92,71,108,96,2,6,133,13,70,12,62" hai2="26,102,38,74,112,90,72,114,54,109,128,98,59" hai3="57,93,21,101,60,3,97,100,49,8,65,132,7" shuffle="mt19937ar,CAFD60E9,71B58B16,1928F817,4E4FED9E,4ECF62E4,BC632468,E4100050,AA3929AE"/>
<T91/><D68/><U94/><E123/><V25/><F38/><W35/><G35/><T88/><D118/><U50/><E108/><V82/><F109/><W33/><G33/><T129/><D5/><U73/><E73/><V115/><F128/><W86/><G132/><T104/><D129/><U28/><E28/><V63/><F72/><W18/><G86/><T9/><D53/><U66/><E70/><V120/><F120/><W95/><G49/><N who="0" m="26759" /><D75/><U81/><E81/><V58/><F58/><W30/><G30/><T105/><D104/><U125/><E125/><V15/><F15/><W130/><G130/><T46/><D105/><U4/><E50/><V113/><N who="2" m="28672" /><DORA hai="22" /><V61/><F61/><W106/><REACH who="3" step="1"/><G100/><REACH who="3" step="2"/><T103/><D103/><N who="1" m="60807" /><E135/><V64/><F64/><W126/><G126/><T134/><D134/><U127/><E66/><V14/><F14/>
<AGARI ba="0,1" hai="3,7,8,14,18,21,57,60,65,93,95,97,101,106" machi="14" ten="30,3900,0" yaku="1,1,7,1,52,1,53,0" doraHai="19,22" doraHaiUra="121,42" who="3" fromWho="2" sc="277,0,327,0,54,-39,332,49" />
<INIT seed="5,0,0,0,4,30" ten="277,327,15,381" oya="1" hai0="112,51,8,87,79,54,13,120,4,48,70,133,66" hai1="116,60,32,19,128,126,108,34,90,109,97,93,98" hai2="111,41,33,100,56,68,123,28,75,80,135,14,5" hai3="118,125,134,119,26,17,99,38,11,36,85,121,83" shuffle="mt19937ar,7328BFB8,9460C433,21D49D85,09C88C4F,649F39DF,AC5D45F2,14DE6298,C5506D0B"/>
<U2/><E116/><N who="3" m="44586" /><G99/><T104/><D112/><U129/><E2/><V23/><F68/><W67/><G67/><T53/><D104/><U22/><E126/><V114/><F123/><W20/><G121/><T3/><D120/><U77/><E77/><V89/><F114/><W21/><G11/><T124/><D124/><U71/><E71/><V57/><F111/><N who="1" m="42569" /><E60/><V74/><F100/><W15/><G134/><T0/><D133/><U72/><E98/><V64/><F135/><W40/><G40/><T35/><D70/><U7/><E7/><V29/><F41/><W12/><G125/><T91/><D66/><U113/><E72/><V27/><F29/><N who="3" m="17607" /><G12/><T63/><D79/>
<AGARI ba="0,0" hai="15,17,21,36,38,79,83,85" m="17607,44586" machi="79" ten="30,1000,0" yaku="12,1" doraHai="30" who="3" fromWho="0" sc="277,-10,327,0,15,0,381,10" />
<INIT seed="6,0,0,5,0,30" ten="267,327,15,391" oya="2" hai0="124,62,12,90,16,110,130,132,117,79,39,135,44" hai1="53,21,129,94,105,122,72,38,126,40,99,27,64" hai2="41,50,54,82,96,6,46,108,1,78,95,133,26" hai3="49,23,37,71,127,75,101,3,8,80,7,98,15" shuffle="mt19937ar,A5CC7EA7,5339C184,D86C1591,CBE69056,C85412A9,A1A9EFFA,7B12FF0C,D07EEB74"/>
<V81/><F133/><N who="0" m="51274" /><D110/><U20/><E122/><V113/><F108/><W85/><G37/><T93/><D79/><U22/><E72/><V43/><F113/><W115/><G75/><T112/><D112/><U66/><E129/><V5/><F26/><W57/><G115/><T63/><D130/><U2/><E2/><V29/><F29/><W121/><G71/><T4/><D4/><U91/><E126/><V103/><F81/><W17/><G127/><T125/><D117/><U60/><E105/><V84/><REACH who="2" step="1"/><F1/><REACH who="2" step="2"/><W116/><G3/><T18/><D124/><U134/><E134/><V31/><F31/><W109/><G80/><T55/><D125/><U97/><E27/><V0/><F0/><W36/><G109/><T13/><D12/><U128/><E128/><V114/><F114/><W119/><G15/><T86/><D13/><U107/><E66/><V58/><F58/><W33/><G57/><T61/><D44/><U73/><E64/><V111/><F111/><W89/><G119/><T24/><D24/><U14/><E14/><V68/><F68/><W70/><G70/><T65/><D65/><U11/><E73/><V9/><F9/><W131/><G8/><T42/><D63/><U47/><E11/><V28/><F28/><W35/><G116/><T77/><D62/><U45/><E60/><V59/><F59/><W100/><G131/><T67/><D61/><U69/><E69/><V120/><F120/><W48/><G121/><T32/><D67/><U19/><E47/><V51/><F51/><W123/><G49/><T106/><D39/><U104/><E38/>
<RYUUKYOKU ba="0,1" sc="267,-10,327,-10,5,30,391,-10" hai2="5,6,41,43,46,50,54,78,82,84,95,96,103" />
<INIT seed="6,1,1,5,2,38" ten="257,317,35,381" oya="2" hai0="74,98,82,108,104,117,90,33,14,26,30,5,55" hai1="32,57,95,62,124,115,67,70,89,6,21,63,100" hai2="29,58,109,119,73,50,120,126,131,69,11,48,135" hai3="86,61,7,128,28,72,41,20,42,112,83,125,91" shuffle="mt19937ar,B5E815BC,59DB44FE,27F75202,FC31A789,D070EE82,FF30D501,2D3CF243,168B179D"/>
<V43/><F73/><W51/><G72/><T31/><D108/><U87/><E115/><V36/><F29/><W116/><G116/><T77/><D117/><U85/><E124/><V15/><F119/><W40/><G112/><T88/><D31/><U81/><E32/><V97/><F120/><W76/><G125/><T17/><D5/><U96/><E6/><V93/><F126/><W132/><G132/><T8/><REACH who="0" step="1"/><D55/><REACH who="0" step="2"/><U47/><E87/><V122/><F122/><W18/><G7/><T101/>
<AGARI ba="1,2" hai="8,14,17,26,30,33,74,77,82,88,90,98,101,104" machi="101" ten="30,7900,0" yaku="1,1,2,1,0,1,54,1,53,0" doraHai="38" doraHaiUra="113" who="0" fromWho="0" sc="247,102,317,-21,35,-40,381,-21" owari="349,15,296,-10,-5,-51,360,46" />
</mjloggm>'''

# タグを抽出
tags = re.findall(r'<[^>]+>', log)

# データを格納
round_data = []
current_round = None
player_hands = [[] for _ in range(4)]

for tag in tags:
    if tag.startswith('<INIT'):
        # 局の開始時に手牌をリセットして初期化
        current_round = {
            'seed': re.search(r'seed="([^"]+)"', tag).group(1).split(','),
            'ten': re.search(r'ten="([^"]+)"', tag).group(1).split(','),
            'oya': int(re.search(r'oya="(\d)"', tag).group(1)),
            'hai': [re.search(r'hai(\d)="([^"]+)"', tag).group(2).split(',') for i in range(4)]
        }
        player_hands = [list(map(int, current_round['hai'][i])) for i in range(4)]
        print(f"局開始: round={current_round['seed'][0]}, player_hands={player_hands}")
    elif re.match(r'<[TUVW][0-9]+>', tag):  # ツモタグを処理
        player = 'TUVW'.index(tag[1])
        tile = int(tag[2:-1])
        player_hands[player].append(tile)
        print(f"ツモ: プレイヤー{player}, 牌={tile}, 手牌={player_hands[player]}")
    elif re.match(r'<[DEFG][0-9]+>', tag):  # 打牌タグを処理
        player = 'DEFG'.index(tag[1])
        tile = int(tag[2:-1])
        if tile in player_hands[player]:
            player_hands[player].remove(tile)
        else:
            print(f"警告: プレイヤー{player}の手牌に牌{tile}がありません")
        # 特徴量を構築
        features = {
            'round': int(current_round['seed'][0]),
            'oya': 1 if player == current_round['oya'] else 0,
            'ten': int(current_round['ten'][player]),
            'tsumo': player_hands[player][-1] if player_hands[player] else None,
            'hand': player_hands[player][:-1] if player_hands[player] else [],
            'discard': tile
        }
        round_data.append(features)
        print(f"打牌: プレイヤー{player}, 牌={tile}, features={features}")
    elif tag.startswith('<AGARI') or tag.startswith('<RYUUKYOKU'):
        # 局の終了時に手牌をリセット
        print(f"局終了: tag={tag}")
        player_hands = [[] for _ in range(4)]

# 結果確認（最初の5つを表示）
print(f"round_dataのサイズ: {len(round_data)}")
for data in round_data[:5]:
    print(data)